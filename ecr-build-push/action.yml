name: ECR build and push action
description: Builds and pushes Docker images to ECR

inputs:
  codeartifact-domain:
    description: The Codeartifact domain.
    required: false
  codeartifact-domain-owner:
    description: The Codeartifact domain owner.
    required: false
  codeartifact-namespace:
    description: The Codeartifact namespace.
    required: false
  codeartifact-region:
    description: The region to use for Codeartifact.
    required: false
  codeartifact-repository:
    description: The Codeartifact repository.
    required: false
  codeartifact-role-arn:
    description: A role to assume for authenticating with Codeartifact.
    required: false
  ecr-region:
    description: The region to use for ECR.
    required: true
  ecr-role-arn:
    description: A role to assume for pulling packages from Codeartifact and publishing to ECR.
    required: true

runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v3
  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v2
  - name: Assume ECR role
    uses: aws-actions/configure-aws-credentials@v1
    with:
      aws-region: ${{ inputs.ecr-region }}
      role-to-assume: ${{ inputs.ecr-role-arn }}
  - name: Login to Amazon ECR
    id: login-ecr
    uses: aws-actions/amazon-ecr-login@v1
  - name: Get ECR repo name
    id: ecr-repo-name
    env:
      REPO: ${{ github.repository }}
    shell: bash
    run: echo "::set-output name=repo-name::app/${REPO/*\//}"
  - name: Create ECR repo
    uses: byerobot/create-ecr-repository-action@v1
    id: create-ecr-repo
    with:
      repository: ${{ steps.ecr-repo-name.outputs.repo-name }}
      repository-policy: .github/ecr-repo-policy.json
  - name: Assume ECR role
    if: inputs.codeartifact-role-arn != ''
    uses: aws-actions/configure-aws-credentials@v1
    with:
      aws-region: ${{ inputs.codeartifact-region }}
      role-to-assume: ${{ inputs.codeartifact-role-arn }}
  - name: Authenticate with CodeArtifact
    if: inputs.codeartifact-repository != ''
    shell: bash
    run: |
      aws codeartifact login \
        --tool npm \
        --domain ${{ inputs.codeartifact-domain }} \
        --domain-owner ${{ inputs.codeartifact-domain-owner }} \
        --namespace ${{ inputs.codeartifact-namespace }} \
        --repository ${{ inputs.codeartifact-repository }}
  - name: Build and push
    uses: docker/build-push-action@v3
    with:
      context: .
      push: true
      tags: ${{ steps.create-ecr-repo.outputs.repository-uri }}:${{ github.sha }}
      cache-from: type=gha
      cache-to: type=gha,mode=max
      secret-files: |
        "npmrc=/home/runner/.npmrc"
